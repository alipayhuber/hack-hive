From 81d715e2c68e8eb3fd4340daa051cbc649c3fb57 Mon Sep 17 00:00:00 2001
From: Prasad Mujumdar <prasadm@cloudera.com>
Date: Fri, 13 Jun 2014 13:20:12 -0700
Subject: [PATCH 358/375] HIVE-7177: CDH-19242: Permissions are not inherited from parent table on renaming a partition

---
 .../org/apache/hadoop/hive/common/FileUtils.java   |   25 ++++++++++++++++++++
 .../hive/ql/security/FolderPermissionBase.java     |   11 +++++---
 .../hadoop/hive/metastore/HiveAlterHandler.java    |    2 +-
 .../apache/hadoop/hive/metastore/Warehouse.java    |   11 ++++----
 4 files changed, 39 insertions(+), 10 deletions(-)

diff --git a/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java b/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
index 48340b8..9b16f15 100644
--- a/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
+++ b/src/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
@@ -431,4 +431,29 @@ public static boolean moveToTrash(FileSystem fs, Path f, Configuration conf) thr
     }
     return result;
   }
+
+  public static boolean renameWithPerms(FileSystem fs, Path sourcePath,
+                               Path destPath, boolean inheritPerms,
+                               Configuration conf) throws IOException {
+    LOG.info("Renaming " + sourcePath + " to " + destPath);
+    if (!inheritPerms) {
+      //just rename the directory
+      return fs.rename(sourcePath, destPath);
+    } else {
+      //rename the directory
+      if (fs.rename(sourcePath, destPath)) {
+        HadoopShims shims = ShimLoader.getHadoopShims();
+        HdfsFileStatus fullFileStatus = shims.getFullFileStatus(conf, fs, destPath.getParent());
+        try {
+          shims.setFullFileStatus(conf, fullFileStatus, fs, destPath);
+        } catch (Exception e) {
+          LOG.warn("Error setting permissions or group of " + destPath, e);
+        }
+
+        return true;
+      }
+
+      return false;
+    }
+  }
 }
diff --git a/src/itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/security/FolderPermissionBase.java b/src/itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/security/FolderPermissionBase.java
index 57fe4cf..154cec5 100644
--- a/src/itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/security/FolderPermissionBase.java
+++ b/src/itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/security/FolderPermissionBase.java
@@ -185,17 +185,20 @@ public void testAlterPartition() throws Exception {
     ret = driver.run("insert into table " + tableName + " partition(part1='1',part2='1',part3='1') select key,value from mysrc");
     Assert.assertEquals(0,ret.getResponseCode());
 
+    assertExistence(warehouseDir + "/" + tableName);
+    setPermission(warehouseDir + "/" + tableName, 1);
+
     //alter partition
     ret = driver.run("alter table " + tableName + " partition (part1='1',part2='1',part3='1') rename to partition (part1='2',part2='2',part3='2')");
     Assert.assertEquals(0,ret.getResponseCode());
 
-    verifyPermission(warehouseDir + "/" + tableName + "/part1=2");
-    verifyPermission(warehouseDir + "/" + tableName + "/part1=2/part2=2");
-    verifyPermission(warehouseDir + "/" + tableName + "/part1=2/part2=2/part3=2");
+    verifyPermission(warehouseDir + "/" + tableName + "/part1=2", 1);
+    verifyPermission(warehouseDir + "/" + tableName + "/part1=2/part2=2", 1);
+    verifyPermission(warehouseDir + "/" + tableName + "/part1=2/part2=2/part3=2", 1);
 
     Assert.assertTrue(listStatus(warehouseDir + "/" + tableName + "/part1=2/part2=2/part3=2").size() > 0);
     for (String child : listStatus(warehouseDir + "/" + tableName + "/part1=2/part2=2/part3=2")) {
-      verifyPermission(child);
+      verifyPermission(child, 1);
     }
   }
 
diff --git a/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveAlterHandler.java b/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveAlterHandler.java
index b29e5d6..9beee24 100644
--- a/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveAlterHandler.java
+++ b/src/metastore/src/java/org/apache/hadoop/hive/metastore/HiveAlterHandler.java
@@ -384,7 +384,7 @@ public Partition alterPartition(final RawStore msdb, Warehouse wh, final String 
             if (!wh.mkdirs(destParentPath, true)) {
                 throw new IOException("Unable to create path " + destParentPath);
             }
-            srcFs.rename(srcPath, destPath);
+            wh.renameDir(srcPath, destPath, true);
             LOG.info("rename done!");
           }
         } catch (IOException e) {
diff --git a/src/metastore/src/java/org/apache/hadoop/hive/metastore/Warehouse.java b/src/metastore/src/java/org/apache/hadoop/hive/metastore/Warehouse.java
index 62f0186..6cf8a26 100755
--- a/src/metastore/src/java/org/apache/hadoop/hive/metastore/Warehouse.java
+++ b/src/metastore/src/java/org/apache/hadoop/hive/metastore/Warehouse.java
@@ -43,7 +43,6 @@
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
 import org.apache.hadoop.fs.permission.FsAction;
-import org.apache.hadoop.fs.permission.FsPermission;
 import org.apache.hadoop.hive.common.FileUtils;
 import org.apache.hadoop.hive.common.JavaUtils;
 import org.apache.hadoop.hive.conf.HiveConf;
@@ -192,11 +191,13 @@ public boolean mkdirs(Path f, boolean inheritPermCandidate) throws MetaException
   }
 
   public boolean renameDir(Path sourcePath, Path destPath) throws MetaException {
-    FileSystem fs = null;
+    return renameDir(sourcePath, destPath, false);
+  }
+
+  public boolean renameDir(Path sourcePath, Path destPath, boolean inheritPerms) throws MetaException {
     try {
-      fs = getFs(sourcePath);
-      fs.rename(sourcePath, destPath);
-      return true;
+      FileSystem fs = getFs(sourcePath);
+      return FileUtils.renameWithPerms(fs, sourcePath, destPath, inheritPerms, conf);
     } catch (Exception ex) {
       MetaStoreUtils.logAndThrowMetaException(ex);
     }
-- 
1.7.0.4

