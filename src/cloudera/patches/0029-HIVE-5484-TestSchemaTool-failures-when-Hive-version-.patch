From f33511bbad7652d80be5a6fabaabb90d61b6ffb2 Mon Sep 17 00:00:00 2001
From: Ashutosh Chauhan <hashutosh@apache.org>
Date: Wed, 9 Oct 2013 15:52:28 +0000
Subject: [PATCH 029/375] HIVE-5484 : TestSchemaTool failures when Hive version has more than 3 revision numbers (Jason Dere via Ashutosh Chauhan)

git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1530688 13f79535-47bb-0310-9956-ffa450edef68
---
 common/build.xml                                   |    6 ++++++
 .../apache/hive/common/HiveVersionAnnotation.java  |    6 ++++++
 .../apache/hive/common/util/HiveVersionInfo.java   |    8 ++++++++
 common/src/scripts/saveVersion.sh                  |   15 +++++++++------
 .../hadoop/hive/metastore/MetaStoreSchemaInfo.java |    4 ++--
 5 files changed, 31 insertions(+), 8 deletions(-)

diff --git a/src/common/build.xml b/src/common/build.xml
index 8268749..bb595dc 100755
--- a/src/common/build.xml
+++ b/src/common/build.xml
@@ -30,9 +30,15 @@ to call at top-level: ant deploy-contrib compile-core-test
 
   <target name="compile" depends="init, setup, ivy-retrieve">
     <echo message="Project: ${ant.project.name}"/>
+    <!-- Restrict short version to just major.minor.change numbers -->
+    <propertyregex property="shortversion"
+      input="${version}" regexp="^([0-9]+\.[0-9]+\.[0-9]+)"
+      select="\1" defaultValue="${version}"
+    />
     <exec executable="bash" failonerror="true">
       <arg value="${basedir}/src/scripts/saveVersion.sh"/>
       <arg value="${version}"/>
+      <arg value="${shortversion}"/>
       <arg value="${basedir}/src"/>
     </exec>
     <javac
diff --git a/src/common/src/java/org/apache/hive/common/HiveVersionAnnotation.java b/src/common/src/java/org/apache/hive/common/HiveVersionAnnotation.java
index 0060ce8..140bdbc 100644
--- a/src/common/src/java/org/apache/hive/common/HiveVersionAnnotation.java
+++ b/src/common/src/java/org/apache/hive/common/HiveVersionAnnotation.java
@@ -41,6 +41,12 @@
   String version();
 
   /**
+   * Get the Hive short version containing major/minor/change version numbers
+   * @return the short version string "0.6.3"
+   */
+  String shortVersion();
+
+  /**
    * Get the username that compiled Hive.
    */
   String user();
diff --git a/src/common/src/java/org/apache/hive/common/util/HiveVersionInfo.java b/src/common/src/java/org/apache/hive/common/util/HiveVersionInfo.java
index bd59b81..de42e6c 100644
--- a/src/common/src/java/org/apache/hive/common/util/HiveVersionInfo.java
+++ b/src/common/src/java/org/apache/hive/common/util/HiveVersionInfo.java
@@ -58,6 +58,14 @@ public static String getVersion() {
   }
 
   /**
+   * Get the Hive short version, with major/minor/change version numbers.
+   * @return short version string, eg. "0.6.3"
+   */
+  public static String getShortVersion() {
+    return version != null ? version.shortVersion() : "Unknown";
+  }
+
+  /**
    * Get the subversion revision number for the root directory
    * @return the revision number, eg. "451451"
    */
diff --git a/src/common/src/scripts/saveVersion.sh b/src/common/src/scripts/saveVersion.sh
index db1ac0c..5517496 100644
--- a/src/common/src/scripts/saveVersion.sh
+++ b/src/common/src/scripts/saveVersion.sh
@@ -22,10 +22,11 @@ unset LANG
 unset LC_CTYPE
 unset LC_TIME
 version=$1
-src_dir=$2
-revision=$3
-branch=$4
-url=$5
+shortversion=$2
+src_dir=$3
+revision=$4
+branch=$5
+url=$6
 user=`whoami`
 date=`date`
 dir=`pwd`
@@ -68,14 +69,16 @@ url=`echo $url | tr -d '\r'`
 srcChecksum=`echo $srcChecksum | tr -d '\r'`
 
 cat << EOF | \
-  sed -e "s/VERSION/$version/" -e "s/USER/$user/" -e "s/DATE/$date/" \
+  sed -e "s/VERSION/$version/" -e "s/SHORTVERSION/$shortversion/" \
+      -e "s/USER/$user/" -e "s/DATE/$date/" \
       -e "s|URL|$url|" -e "s/REV/$revision/" \
       -e "s|BRANCH|$branch|" -e "s/SRCCHECKSUM/$srcChecksum/" \
       > $src_dir/gen/org/apache/hive/common/package-info.java
 /*
  * Generated by saveVersion.sh
  */
-@HiveVersionAnnotation(version="VERSION", revision="REV", branch="BRANCH",
+@HiveVersionAnnotation(version="VERSION", shortVersion="SHORTVERSION",
+                         revision="REV", branch="BRANCH",
                          user="USER", date="DATE", url="URL",
                          srcChecksum="SRCCHECKSUM")
 package org.apache.hive.common;
diff --git a/src/metastore/src/java/org/apache/hadoop/hive/metastore/MetaStoreSchemaInfo.java b/src/metastore/src/java/org/apache/hadoop/hive/metastore/MetaStoreSchemaInfo.java
index c451468..810d26d 100644
--- a/src/metastore/src/java/org/apache/hadoop/hive/metastore/MetaStoreSchemaInfo.java
+++ b/src/metastore/src/java/org/apache/hadoop/hive/metastore/MetaStoreSchemaInfo.java
@@ -130,9 +130,9 @@ private String generateUpgradeFileName(String fileVersion) {
     return UPGRADE_FILE_PREFIX +  fileVersion + "." + dbType + SQL_FILE_EXTENSION;
   }
 
-  // Current hive version, remove the 'SNAPSHOT' part if needed
+  // Current hive version, in majorVersion.minorVersion.changeVersion format
   public static String getHiveSchemaVersion() {
-    return HiveVersionInfo.getVersion().replace("-SNAPSHOT", "");
+    return HiveVersionInfo.getShortVersion();
   }
 
 }
-- 
1.7.0.4

