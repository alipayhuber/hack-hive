From 0fd0648fedfc0d69bfd2595a060dd157cc137129 Mon Sep 17 00:00:00 2001
From: Prasad Mujumdar <prasadm@cloudera.com>
Date: Fri, 31 Jan 2014 13:32:56 -0800
Subject: [PATCH 264/375] CDH-17142: GetLog() RPC doesn't return the exec logs for async queries. Test update

---
 .../apache/hive/jdbc/miniHS2/TestHiveServer2.java  |   10 ++++++++--
 1 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/src/itests/hive-unit/src/test/java/org/apache/hive/jdbc/miniHS2/TestHiveServer2.java b/src/itests/hive-unit/src/test/java/org/apache/hive/jdbc/miniHS2/TestHiveServer2.java
index 0bce90f..3afe0b2 100644
--- a/src/itests/hive-unit/src/test/java/org/apache/hive/jdbc/miniHS2/TestHiveServer2.java
+++ b/src/itests/hive-unit/src/test/java/org/apache/hive/jdbc/miniHS2/TestHiveServer2.java
@@ -28,6 +28,7 @@
 import org.apache.hadoop.hive.conf.HiveConf;
 import org.apache.hive.service.cli.CLIServiceClient;
 import org.apache.hive.service.cli.OperationHandle;
+import org.apache.hive.service.cli.OperationState;
 import org.apache.hive.service.cli.RowSet;
 import org.apache.hive.service.cli.SessionHandle;
 import org.junit.After;
@@ -37,16 +38,17 @@
 
 public class TestHiveServer2 {
 
-  private static MiniHS2 miniHS2 = null;
+  private MiniHS2 miniHS2 = null;
   private Map<String, String> confOverlay;
 
   @BeforeClass
   public static void beforeTest() throws IOException {
-    miniHS2 = new MiniHS2(new HiveConf());
+    System.setProperty("hive.support.concurrency", "false");
   }
 
   @Before
   public void setUp() throws Exception {
+    miniHS2 = new MiniHS2(new HiveConf());
     miniHS2.start();
     confOverlay = new HashMap<String, String>();
   }
@@ -81,6 +83,10 @@ public void testAsyncGetLog() throws Exception {
     // run async query
     OperationHandle opHandle =
         serviceClient.executeStatementAsync(sessHandle, queryStr, confOverlay);
+    // wait for query to run. Note that the state is set to RUNNING before the returning the control back to client
+    while (OperationState.RUNNING.equals(serviceClient.getOperationStatus(opHandle).getState())) {
+      Thread.sleep(250);
+    }
     String logStr = serviceClient.getLog(opHandle);
     assertTrue("Operation Log looks incorrect", logStr.contains("Starting command: " + queryStr));
 
-- 
1.7.0.4

